name: Mint GitHub App installation token
description: >
  Mint a GitHub App installation token for the current repository using
  the provided App ID and private key.

on:
  workflow_call:
    secrets:
      CI_APP_ID:
        required: true
      CI_APP_KEY:
        required: true

jobs:
  mint:
    runs-on: ubuntu-latest
    outputs:
      release_token: ${{ steps.create.outputs.release_token }}
      installation_id: ${{ steps.create.outputs.installation_id }}
    steps:
      - name: Generate installation token
        id: create
        env:
          CI_APP_ID: ${{ secrets.CI_APP_ID }}
          CI_APP_KEY: ${{ secrets.CI_APP_KEY }}
        run: |
          set -euo pipefail
          # Decode private key
          echo "$CI_APP_KEY" | base64 --decode > /tmp/app_private_key.pem

          # Install minimal Python deps
          python -m pip install --upgrade pip
          python -m pip install PyJWT requests

          # Create JWT, exchange for installation token, and emit outputs
          python - <<'PY' > /tmp/mint_out.env
            import os, time, jwt, requests
            app_id = os.environ['CI_APP_ID']
            private_key = open('/tmp/app_private_key.pem','r').read()
            now = int(time.time())
            payload = {'iat': now - 60, 'exp': now + (9*60), 'iss': int(app_id)}
            jwt_token = jwt.encode(payload, private_key, algorithm='RS256')
            owner, repo = os.environ['GITHUB_REPOSITORY'].split('/')
            headers = {'Authorization': f'Bearer {jwt_token}', 'Accept': 'application/vnd.github+json'}
            # Get installation ID for this repo (works for org or repo installations)
            resp = requests.get(f'https://api.github.com/repos/{owner}/{repo}/installation', headers=headers)
            resp.raise_for_status()
            installation_id = resp.json()['id']
            resp2 = requests.post(f'https://api.github.com/app/installations/{installation_id}/access_tokens', headers=headers)
            resp2.raise_for_status()
            token_value = resp2.json()['token']
            print(f"release_token={token_value}")
            print(f"installation_id={installation_id}")
          PY

          # Append the values to GITHUB_OUTPUT so they become step outputs
          cat /tmp/mint_out.env >> $GITHUB_OUTPUT
